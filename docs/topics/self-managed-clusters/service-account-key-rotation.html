<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Service Account Key Rotation - Azure AD Workload Identity</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="../../favicon.svg">
                        <link rel="shortcut icon" href="../../favicon.png">
                <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
                <link rel="stylesheet" href="../../css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="../../fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../introduction.html">Introduction</a></li><li class="chapter-item expanded "><a href="../../installation.html"><strong aria-hidden="true">1.</strong> Installation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../installation/managed-clusters.html"><strong aria-hidden="true">1.1.</strong> Managed Clusters</a></li><li class="chapter-item expanded "><a href="../../installation/self-managed-clusters.html"><strong aria-hidden="true">1.2.</strong> Self-Managed Clusters</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../installation/self-managed-clusters/service-account-key-generation.html"><strong aria-hidden="true">1.2.1.</strong> Service Account Key Generation</a></li><li class="chapter-item expanded "><a href="../../installation/self-managed-clusters/oidc-issuer.html"><strong aria-hidden="true">1.2.2.</strong> OpenID Connect Issuer</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../installation/self-managed-clusters/oidc-issuer/discovery-document.html"><strong aria-hidden="true">1.2.2.1.</strong> Discovery Document</a></li><li class="chapter-item expanded "><a href="../../installation/self-managed-clusters/oidc-issuer/jwks.html"><strong aria-hidden="true">1.2.2.2.</strong> JSON Web Key Sets (JWKS)</a></li></ol></li><li class="chapter-item expanded "><a href="../../installation/self-managed-clusters/configurations.html"><strong aria-hidden="true">1.2.3.</strong> Configurations</a></li></ol></li><li class="chapter-item expanded "><a href="../../installation/mutating-admission-webhook.html"><strong aria-hidden="true">1.3.</strong> Mutating Admission Webhook</a></li><li class="chapter-item expanded "><a href="../../installation/azwi.html"><strong aria-hidden="true">1.4.</strong> Azure AD Workload Identity CLI (azwi)</a></li></ol></li><li class="chapter-item expanded "><a href="../../quick-start.html"><strong aria-hidden="true">2.</strong> Quick Start</a></li><li class="chapter-item expanded "><a href="../../concepts.html"><strong aria-hidden="true">3.</strong> Concepts</a></li><li class="chapter-item expanded "><a href="../../topics.html"><strong aria-hidden="true">4.</strong> Topics</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../topics/service-account-labels-and-annotations.html"><strong aria-hidden="true">4.1.</strong> Service Account Labels And Annotations</a></li><li class="chapter-item expanded "><a href="../../topics/federated-identity-credential.html"><strong aria-hidden="true">4.2.</strong> Federated Identity Credential</a></li><li class="chapter-item expanded "><a href="../../topics/azwi.html"><strong aria-hidden="true">4.3.</strong> Azure Workload Identity CLI (azwi)</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../topics/azwi/serviceaccount-create.html"><strong aria-hidden="true">4.3.1.</strong> azwi serviceaccount create</a></li><li class="chapter-item expanded "><a href="../../topics/azwi/serviceaccount-delete.html"><strong aria-hidden="true">4.3.2.</strong> azwi serviceaccount delete</a></li><li class="chapter-item expanded "><a href="../../topics/azwi/jwks.html"><strong aria-hidden="true">4.3.3.</strong> azwi jwks</a></li></ol></li><li class="chapter-item expanded "><a href="../../topics/self-managed-clusters.html"><strong aria-hidden="true">4.4.</strong> Self-Managed Clusters</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../topics/self-managed-clusters/service-account-key-rotation.html" class="active"><strong aria-hidden="true">4.4.1.</strong> Service Account Key Rotation</a></li><li class="chapter-item expanded "><a href="../../topics/self-managed-clusters/examples.html"><strong aria-hidden="true">4.4.2.</strong> Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../topics/self-managed-clusters/examples/kind.html"><strong aria-hidden="true">4.4.2.1.</strong> Kubernetes in Docker (kind)</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../topics/language-specific-examples.html"><strong aria-hidden="true">4.5.</strong> Language-Specific Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../topics/language-specific-examples/azure-identity-sdk.html"><strong aria-hidden="true">4.5.1.</strong> Azure Identity client libraries</a></li><li class="chapter-item expanded "><a href="../../topics/language-specific-examples/msal.html"><strong aria-hidden="true">4.5.2.</strong> Microsoft Authentication Library (MSAL)</a></li></ol></li><li class="chapter-item expanded "><a href="../../topics/metrics.html"><strong aria-hidden="true">4.6.</strong> Metrics</a></li></ol></li><li class="chapter-item expanded "><a href="../../faq.html"><strong aria-hidden="true">5.</strong> Frequently Asked Questions</a></li><li class="chapter-item expanded "><a href="../../troubleshooting.html"><strong aria-hidden="true">6.</strong> Troubleshooting</a></li><li class="chapter-item expanded "><a href="../../known-issues.html"><strong aria-hidden="true">7.</strong> Known Issues</a></li><li class="chapter-item expanded "><a href="../../development.html"><strong aria-hidden="true">8.</strong> Development</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../development/releasing.html"><strong aria-hidden="true">8.1.</strong> Releasing</a></li></ol></li><li class="chapter-item expanded "><a href="../../contributing.html"><strong aria-hidden="true">9.</strong> Contributing</a></li><li class="chapter-item expanded "><a href="../../code-of-conduct.html"><strong aria-hidden="true">10.</strong> Code of Conduct</a></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">Azure AD Workload Identity</h1>

                    <div class="right-buttons">
                                                <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        <a href="https://github.com/Azure/azure-workload-identity" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                                                
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="service-account-key-rotation"><a class="header" href="#service-account-key-rotation">Service Account Key Rotation</a></h1>
<ul>
<li><a href="#best-practices">Best Practices</a>
<ul>
<li><a href="#key-rotation">Key rotation</a></li>
<li><a href="#key-retirement">Key retirement</a></li>
</ul>
</li>
<li><a href="#steps-to-manually-generate-and-rotate-keys">Steps to manually generate and rotate keys</a>
<ul>
<li><a href="#1-generate-a-new-key-pair">1. Generate a new key pair</a></li>
<li><a href="#2-backup-the-old-key-pair-and-distribute-the-new-key-pair">2. Backup the old key pair and distribute the new key pair</a></li>
<li><a href="#3-update-the-jwks">3. Update the JWKS</a></li>
<li><a href="#4-key-rotation">4. Key Rotation</a></li>
<li><a href="#5-verification">5. Verification</a></li>
<li><a href="#6-cleanup">6. Cleanup</a></li>
<li><a href="#7-remove-old-jwk-after-maximum-token-expiration">7. Remove old JWK after maximum token expiration</a></li>
</ul>
</li>
</ul>
<p>A security best practice is to routinely rotate your key pair used to sign the service account tokens. This page explains the best practices, guidelines, as well as how to generate and rotate it in the case of self-managed Kubernetes clusters where you have access to the control plane.</p>
<blockquote>
<p>This technique requires that the Kubernetes control plane is running in a high-availability (HA) setup with multiple API servers. Clusters that use a single API server will become unavailable while the API server is restarted.</p>
</blockquote>
<h2 id="best-practices"><a class="header" href="#best-practices">Best Practices</a></h2>
<h3 id="key-rotation"><a class="header" href="#key-rotation">Key rotation</a></h3>
<p>Key pair should be rotated on a regular basis. For references, AKS clusters rotate their service account signing key pairs <strong>every three months</strong>.</p>
<h3 id="key-retirement"><a class="header" href="#key-retirement">Key retirement</a></h3>
<p>Key pair should be retired when they are no longer needed. In most cases, this means permanently removing them to guarantee that it poses no more risk and to minimize the number of active key pairs that are being handled.</p>
<h2 id="steps-to-manually-generate-and-rotate-keys"><a class="header" href="#steps-to-manually-generate-and-rotate-keys">Steps to manually generate and rotate keys</a></h2>
<h3 id="1-generate-a-new-key-pair"><a class="header" href="#1-generate-a-new-key-pair">1. Generate a new key pair</a></h3>
<blockquote>
<p>Skip this step if you are planning to bring your own keys.</p>
</blockquote>
<pre><code class="language-bash">openssl genrsa -out sa-new.key 2048
openssl rsa -in sa-new.key -pubout -out sa-new.pub
</code></pre>
<h3 id="2-backup-the-old-key-pair-and-distribute-the-new-key-pair"><a class="header" href="#2-backup-the-old-key-pair-and-distribute-the-new-key-pair">2. Backup the old key pair and distribute the new key pair</a></h3>
<p>Schedule a jump pod to each control plane node, which mounts the <code>/etc/kubernetes/pki</code> folder:</p>
<blockquote>
<p><code>/etc/kubernetes/pki/sa.pub</code> and <code>/etc/kubernetes/pki/sa.key</code> are the paths of the service account key pair for a kind cluster. The paths can vary depending on your provider.</p>
</blockquote>
<pre><code class="language-bash">cat &lt;&lt; EOF | kubectl apply -f -
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: jump
  labels:
    k8s-app: jump
spec:
  selector:
    matchLabels:
      name: jump
  template:
    metadata:
      labels:
        name: jump
    spec:
      tolerations:
      - key: node-role.kubernetes.io/master
        operator: Exists
        effect: NoSchedule
      containers:
        - name: busybox
          image: busybox
          command:
            - sleep
            - &quot;3600&quot;
          volumeMounts:
              - mountPath: /etc/kubernetes/pki
                name: etc-kubernetes-pki
      volumes:
        - name: etc-kubernetes-pki
          hostPath:
            path: /etc/kubernetes/pki
EOF
</code></pre>
<p>Backup the old service account key pair to your local machine:</p>
<pre><code class="language-bash">POD_NAME=&quot;$(kubectl get po -l name=jump -ojson | jq -r '.items[0].metadata.name')&quot;
kubectl cp default/${POD_NAME}:/etc/kubernetes/pki/sa.pub sa-old.pub
kubectl cp default/${POD_NAME}:/etc/kubernetes/pki/sa.key sa-old.key
</code></pre>
<p>Distribute the new key pair to the certificate directory of each control plane node:</p>
<pre><code class="language-bash">for POD_NAME in &quot;$(kubectl get po -l name=jump -ojson | jq -r '.items[].metadata.name')&quot;; do
  kubectl cp sa-new.pub default/${POD_NAME}:/etc/kubernetes/pki/sa-new.pub
  kubectl cp sa-new.key default/${POD_NAME}:/etc/kubernetes/pki/sa-new.key
done
</code></pre>
<h3 id="3-update-the-jwks"><a class="header" href="#3-update-the-jwks">3. Update the JWKS</a></h3>
<p>In the case of service account tokens generated before you initiated the key rotation, you would need a time period where the old and new public keys exist in the JWKS. The relying party can then validate service account tokens signed by both the old and new private key.</p>
<p>Download <code>azwi</code> from our <a href="https://github.com/Azure/azure-workload-identity/releases">latest GitHub releases</a>, which is a CLI tool that helps generate the JWKS document in JSON.</p>
<p>Generate and upload the JWKS:</p>
<blockquote>
<p>Assuming you followed our <a href="../../quick-start.html">Quick Start</a> and store your OIDC discovery document and JWKS in an Azure storage account.</p>
</blockquote>
<pre><code class="language-bash">azwi jwks --public-keys sa-old.pub --public-keys sa-new.pub --output-file jwks.json
export AZURE_STORAGE_ACCOUNT=&lt;AzureStorageAccount&gt;
az storage blob upload \
  --container-name &quot;${AZURE_STORAGE_CONTAINER}&quot; \
  --file jwks.json \
  --name openid/v1/jwks
</code></pre>
<h3 id="4-key-rotation"><a class="header" href="#4-key-rotation">4. Key Rotation</a></h3>
<p>With the new key pair distributed, you can utilize <a href="https://github.com/kvaps/kubectl-node-shell">kubectl-node-shell</a> to update the following core components arguments by spawning a root shell to each control plane node:</p>
<pre><code class="language-bash">kubectl node-shell &lt;NodeName&gt;

# Run in the root shell
# download yq (jq for yaml)
curl -L https://github.com/mikefarah/yq/releases/download/v4.12.1/yq_linux_amd64 --output /usr/bin/yq
chmod +x /usr/bin/yq

# append the new public key as an kube-apiserver argument
yq eval -i '.spec.containers[0].command |= . + [&quot;--service-account-key-file=/etc/kubernetes/pki/sa-new.pub&quot;]' /etc/kubernetes/manifests/kube-apiserver.yaml

# replace the old private key with the new private key for kube-apiserver and kube-controller-manager
sed -i 's|--service-account-signing-key-file=.*|--service-account-signing-key-file=/etc/kubernetes/pki/sa-new.key|' /etc/kubernetes/manifests/kube-apiserver.yaml
sed -i 's|--service-account-private-key-file=.*|--service-account-private-key-file=/etc/kubernetes/pki/sa-new.key|' /etc/kubernetes/manifests/kube-controller-manager.yaml
</code></pre>
<p>The commands above should trigger a restart for kube-apiserver and kube-controller-manager pod.</p>
<h3 id="5-verification"><a class="header" href="#5-verification">5. Verification</a></h3>
<p>Create a dummy pod that uses an annotated service account.</p>
<pre><code class="language-bash">cat &lt;&lt; EOF | kubectl apply -f -
apiVersion: v1
kind: ServiceAccount
metadata:
  annotations:
    azure.workload.identity/client-id: dummy
  name: workload-identity-sa
---
apiVersion: v1
kind: Pod
metadata:
  name: dummy-pod
  labels:
    azure.workload.identity/use: &quot;true&quot;
spec:
  serviceAccountName: workload-identity-sa
  containers:
    - name: busybox
      image: busybox
      command:
        - sleep
        - &quot;3600&quot;
EOF
</code></pre>
<p>Output the projected service account token:</p>
<pre><code class="language-bash">kubectl exec dummy-pod -- cat /var/run/secrets/azure/tokens/azure-identity-token
</code></pre>
<p>Decode your token using <a href="https://jwt.ms">jwt.ms</a>. The <code>kid</code> field in the token header should be the same as the <code>kid</code> of <code>azwi jwks --public-keys sa-new.pub | jq -r '.keys[0].kid'</code>. This means that the service account token is signed by the new private key.</p>
<h3 id="6-cleanup"><a class="header" href="#6-cleanup">6. Cleanup</a></h3>
<p>Delete the dangling resources created above:</p>
<pre><code class="language-bash">kubectl delete ds jump
kubectl delete pod dummy-pod
kubectl delete sa workload-identity-sa
</code></pre>
<h3 id="7-remove-old-jwk-after-maximum-token-expiration"><a class="header" href="#7-remove-old-jwk-after-maximum-token-expiration">7. Remove old JWK after maximum token expiration</a></h3>
<p>After the maximum token expiration (the default expiration is 24 hours) has passed, projected service account tokens signed by the old private key will be rotated by kubelet and signed with the new signing key. The kubelet proactively rotates the token if it is older than 80% of its total TTL, or if the token is older than 24 hours. You should update the JWKS accordingly to only include the new public key:</p>
<pre><code class="language-bash">azwi jwks --public-keys sa-new.pub --output-file jwks.json
az storage blob upload \
  --container-name &quot;${AZURE_STORAGE_CONTAINER}&quot; \
  --file jwks.json \
  --name openid/v1/jwks
</code></pre>
<p>Remove the old public key from kube-apiserver’s arguments:</p>
<pre><code class="language-bash"># get the index of the old public key from the kube-apiserver argument array
INDEX=&quot;$(yq e '.spec.containers[0].command' /etc/kubernetes/manifests/kube-apiserver.yaml | grep -Fn 'service-account-key-file' | head -n 1 | cut -d':' -f1)&quot;

# convert to zero-index
INDEX=&quot;$(expr ${INDEX} - 1)&quot;

# remove the old public key argument using yq
yq eval -i &quot;del(.spec.containers[0].command[${INDEX}])&quot; /etc/kubernetes/manifests/kube-apiserver.yaml

# remove the old key pair from disk
rm sa.*
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="../../topics/self-managed-clusters.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="../../topics/self-managed-clusters/examples.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="../../topics/self-managed-clusters.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="../../topics/self-managed-clusters/examples.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        
    </body>
</html>
