<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Quick Start - AAD Pod Managed Identity</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="favicon.svg">
                        <link rel="shortcut icon" href="favicon.png">
                <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
                <link rel="stylesheet" href="css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="introduction.html">Introduction</a></li><li class="chapter-item expanded affix "><a href="quick-start.html" class="active">Quick Start</a></li><li class="chapter-item expanded affix "><a href="concepts.html">Concepts</a></li><li class="chapter-item expanded "><a href="topics.html"><strong aria-hidden="true">1.</strong> Topics</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="topics/labels-and-annotations.html"><strong aria-hidden="true">1.1.</strong> Labels And Annotations</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.</strong> Troubleshooting</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.</strong> Known Limitations</div></li><li class="chapter-item expanded "><a href="development.html"><strong aria-hidden="true">4.</strong> Development</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="development/releasing.html"><strong aria-hidden="true">4.1.</strong> Releasing</a></li></ol></li><li class="chapter-item expanded "><a href="contributing.html"><strong aria-hidden="true">5.</strong> Contributing</a></li><li class="chapter-item expanded "><a href="code-of-conduct.html"><strong aria-hidden="true">6.</strong> Code of Conduct</a></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">AAD Pod Managed Identity</h1>

                    <div class="right-buttons">
                                                <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        <a href="https://github.com/Azure/aad-pod-managed-identity" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                                                
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="quick-start"><a class="header" href="#quick-start">Quick Start</a></h1>
<!-- toc -->
<p>In this tutorial, we will cover the basics of how to use the AAD Pod Identity webhook to acquire a token to access a secret in an <a href="https://azure.microsoft.com/en-us/services/key-vault/">Azure Key Vault</a>. If you are using an AKS cluster with OIDC enabled, you may skip step 0 to step 4.</p>
<h2 id="prerequisites"><a class="header" href="#prerequisites">Prerequisites</a></h2>
<ul>
<li><a href="https://kubernetes.io/docs/tasks/tools/">kubectl</a></li>
<li><a href="https://kind.sigs.k8s.io/docs/user/quick-start/#installation">kind</a> and <a href="https://www.docker.com/">Docker</a></li>
<li><a href="https://azure.microsoft.com/en-us/">Microsoft Azure</a> account</li>
<li><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli">Azure CLI</a></li>
</ul>
<h2 id="0-export-environment-variables-and-create-resource-group"><a class="header" href="#0-export-environment-variables-and-create-resource-group">0. Export environment variables and create resource group</a></h2>
<p>Export the following environment variables:</p>
<pre><code class="language-bash">export RESOURCE_GROUP=&quot;aad-pi-webhook-test&quot;
export LOCATION=&quot;westus2&quot;
az group create --name &quot;${RESOURCE_GROUP}&quot; --location &quot;${LOCATION}&quot;
</code></pre>
<h2 id="1-create-and-upload-oidc-discovery-document-and-jwks"><a class="header" href="#1-create-and-upload-oidc-discovery-document-and-jwks">1. Create and upload OIDC discovery document and JWKS</a></h2>
<blockquote>
<p>Skip this step if you are planning to bring your own keys.</p>
</blockquote>
<p>Generate a public/private key pair:</p>
<pre><code class="language-bash">openssl genrsa -out sa.key 2048
openssl rsa -in sa.key -pubout -out sa.pub
</code></pre>
<details>
<summary>Output</summary>
<pre><code class="language-bash">Generating RSA private key, 2048 bit long modulus
..............+++
......+++
e is 65537 (0x10001)
writing RSA key
</code></pre>
</details>
<blockquote>
<p>Skip this step if you already set up the OIDC discovery document and JWKS.</p>
</blockquote>
<p>Azure blob storage will be used to host the OIDC discovery document and JWKS. However, you can host them in anywhere, as long as they are publicly available.</p>
<pre><code class="language-bash">export AZURE_STORAGE_ACCOUNT=&quot;pmi$(openssl rand -hex 4)&quot;
export AZURE_STORAGE_CONTAINER=&quot;oidc-test&quot;
az storage account create --resource-group &quot;${RESOURCE_GROUP}&quot; --name &quot;${AZURE_STORAGE_ACCOUNT}&quot;
az storage container create --name &quot;${AZURE_STORAGE_CONTAINER}&quot; --public-access container
</code></pre>
<p>Generate and upload the OIDC discovery document:</p>
<pre><code class="language-bash">cat &lt;&lt;EOF &gt; openid-configuration.json
{
  &quot;issuer&quot;: &quot;https://${AZURE_STORAGE_ACCOUNT}.blob.core.windows.net/${AZURE_STORAGE_CONTAINER}/&quot;,
  &quot;authorization_endpoint&quot;: &quot;https://${AZURE_STORAGE_ACCOUNT}.blob.core.windows.net/${AZURE_STORAGE_CONTAINER}/connect/authorize&quot;,
  &quot;jwks_uri&quot;: &quot;https://${AZURE_STORAGE_ACCOUNT}.blob.core.windows.net/${AZURE_STORAGE_CONTAINER}/openid/v1/jwks&quot;,
  &quot;response_types_supported&quot;: [
    &quot;id_token&quot;
  ],
  &quot;subject_types_supported&quot;: [
    &quot;public&quot;
  ],
  &quot;id_token_signing_alg_values_supported&quot;: [
    &quot;RS256&quot;
  ]
}
EOF
az storage blob upload \
  --container-name &quot;${AZURE_STORAGE_CONTAINER}&quot; \
  --file openid-configuration.json \
  --name .well-known/openid-configuration
</code></pre>
<p>Generate and upload the JWKS:</p>
<pre><code class="language-bash">pushd hack/generate-jwks
go run main.go --public-keys ../../sa.pub | jq &gt; jwks.json
az storage blob upload \
  --container-name &quot;${AZURE_STORAGE_CONTAINER}&quot; \
  --file jwks.json \
  --name openid/v1/jwks
popd
</code></pre>
<p>Verify that the OIDC discovery document is publicly accessible:</p>
<pre><code class="language-bash">curl -s &quot;https://${AZURE_STORAGE_ACCOUNT}.blob.core.windows.net/${AZURE_STORAGE_CONTAINER}/.well-known/openid-configuration&quot;
</code></pre>
<details>
<summary>Output</summary>
<pre><code class="language-json">{
  &quot;issuer&quot;: &quot;https://&lt;REDACTED&gt;.blob.core.windows.net/oidc-test/&quot;,
  &quot;authorization_endpoint&quot;: &quot;https://&lt;REDACTED&gt;.blob.core.windows.net/oidc-test/connect/authorize&quot;,
  &quot;jwks_uri&quot;: &quot;https://&lt;REDACTED&gt;.blob.core.windows.net/oidc-test/openid/v1/jwks&quot;,
  &quot;response_types_supported&quot;: [
    &quot;id_token&quot;
  ],
  &quot;subject_types_supported&quot;: [
    &quot;public&quot;
  ],
  &quot;id_token_signing_alg_values_supported&quot;: [
    &quot;RS256&quot;
  ]
}
</code></pre>
</details>
<p>Verify that the JWKS is publicly accessible:</p>
<pre><code class="language-bash">curl -s &quot;https://${AZURE_STORAGE_ACCOUNT}.blob.core.windows.net/${AZURE_STORAGE_CONTAINER}/openid/v1/jwks&quot;
</code></pre>
<details>
<summary>Output</summary>
<pre><code class="language-json">{
  &quot;keys&quot;: [
    {
      &quot;use&quot;: &quot;sig&quot;,
      &quot;kty&quot;: &quot;RSA&quot;,
      &quot;kid&quot;: &quot;Me5VC6i4_4mymFj7T5rcUftFjYX70YoCfSnZB6-nBY4&quot;,
      &quot;alg&quot;: &quot;RS256&quot;,
      &quot;n&quot;: &quot;ywg7HeKIFX3vleVKZHeYoNpuLHIDisnczYXrUdIGCNilCJFA1ymjG2UAADnt_FpYUsCVyKYJTqcxNbK4boNg_P3uK39OAqXabwYrilEZvsVJQKhzn8dXLeqAnM98L8eBpySU208KTsfMkS3Q6lqwurUP7c_a3g_1XRJukz_EmQxg9jLD_fQd5VwPTEo8HJQIFqIxFWzjTkkK5hbcL9Cclkf6RpeRyjh7Vem57Fu-jAlxDUiYiqyieM4OBNm4CQjiqDE8_xOC8viNpHNw542MYVDKSRnYui31lCOj32wBDphczR8BbnrZgbqN3K_zzB3gIjcGbWbbGA5xKJYqSu5uRwN89_CWrT3vGw5RN3XQPSbhGC4smgZkOCw3N9i1b-x-rrd-mRse6F95ONaoslCJUbJvxvDdb5X0P4_CVZRwJvUyP3OJ44ZvwzshA-zilG-QC9E1j2R9DTSMqOJzUuOxS0JIvoboteI1FAByV9KyU948zQRM7r7MMZYBKWIsu6h7&quot;,
      &quot;e&quot;: &quot;AQAB&quot;
    }
  ]
}
</code></pre>
</details>
<h2 id="2-create-a-kind-cluster"><a class="header" href="#2-create-a-kind-cluster">2. Create a kind cluster</a></h2>
<p>Export the following environment variables:</p>
<pre><code class="language-bash">export SERVICE_ACCOUNT_ISSUER=&quot;https://${AZURE_STORAGE_ACCOUNT}.blob.core.windows.net/${AZURE_STORAGE_CONTAINER}/&quot;
export SERVICE_ACCOUNT_KEY_FILE=&quot;$(pwd)/sa.pub&quot;
export SERVICE_ACCOUNT_SIGNING_KEY_FILE=&quot;$(pwd)/sa.key&quot;
</code></pre>
<p>Create a kind cluster with one control plane node and customize various service account-related flags for the API server:</p>
<blockquote>
<p>The minimum supported Kubernetes version for the webhook is v1.18.0, however, we recommend using Kubernetes version v1.20.0+.</p>
</blockquote>
<pre><code class="language-bash">cat &lt;&lt;EOF | kind create cluster --name aad-pod-managed-identity --image kindest/node:v1.21.1 --config=-
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
  extraMounts:
    - hostPath: ${SERVICE_ACCOUNT_KEY_FILE}
      containerPath: /etc/kubernetes/pki/sa.pub
    - hostPath: ${SERVICE_ACCOUNT_SIGNING_KEY_FILE}
      containerPath: /etc/kubernetes/pki/sa.key
  kubeadmConfigPatches:
  - |
    kind: ClusterConfiguration
    apiServer:
      extraArgs:
        service-account-issuer: ${SERVICE_ACCOUNT_ISSUER}
        service-account-key-file: /etc/kubernetes/pki/sa.pub
        service-account-signing-key-file: /etc/kubernetes/pki/sa.key
EOF
</code></pre>
<details>
<summary>Output</summary>
<pre><code class="language-bash">Creating cluster &quot;aad-pod-managed-identity&quot; ...
 ‚Ä¢ Ensuring node image (kindest/node:v1.21.1) üñº  ...
 ‚úì Ensuring node image (kindest/node:v1.21.1) üñº
 ‚Ä¢ Preparing nodes üì¶   ...
 ‚úì Preparing nodes üì¶
 ‚Ä¢ Writing configuration üìú  ...
 ‚úì Writing configuration üìú
 ‚Ä¢ Starting control-plane üïπÔ∏è  ...
 ‚úì Starting control-plane üïπÔ∏è
 ‚Ä¢ Installing CNI üîå  ...
 ‚úì Installing CNI üîå
 ‚Ä¢ Installing StorageClass üíæ  ...
 ‚úì Installing StorageClass üíæ
Set kubectl context to &quot;kind-aad-pod-managed-identity&quot;
You can now use your cluster with:

kubectl cluster-info --context kind-aad-pod-managed-identity

Have a question, bug, or feature request? Let us know! https://kind.sigs.k8s.io/#community üôÇ
</code></pre>
</details>
<p>Run the following command to verify that the kind cluster is online:</p>
<pre><code class="language-bash">kubectl get nodes
</code></pre>
<details>
<summary>Output</summary>
<pre><code class="language-bash">NAME                                     STATUS   ROLES                  AGE     VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE       KERNEL-VERSION     CONTAINER-RUNTIME
aad-pod-managed-identity-control-plane   Ready    control-plane,master   2m28s   v1.21.1   172.18.0.2    &lt;none&gt;        Ubuntu 21.04   5.4.0-1047-azure   containerd://1.5.2
</code></pre>
</details>
<h2 id="3-install-the-aad-pod-identity-webhook"><a class="header" href="#3-install-the-aad-pod-identity-webhook">3. Install the AAD Pod Identity webhook</a></h2>
<p>Obtain your Azure tenant ID by running the following command:</p>
<pre><code class="language-bash">export AZURE_TENANT_ID=&quot;$(az account show -s &lt;AzureSubscriptionID&gt; --query tenantId -otsv)&quot;
# TODO: account for different environments
export AZURE_ENVIRONMENT=&quot;AzurePublicCloud&quot;
</code></pre>
<p>To install the webhook, choose one of the following options below:</p>
<ol>
<li>
<p>Deployment YAML</p>
<blockquote>
<p>Replace the Azure tenant ID and cloud environment name in <a href="https://github.com/Azure/aad-pod-managed-identity/blob/c6b92d50910091441a71c1cb32517d53649d74e7/manifest_staging/deploy/aad-pi-webhook.yaml#L45-L46">here</a> before executing</p>
</blockquote>
<pre><code class="language-bash">sed -i &quot;s/AZURE_TENANT_ID: .*/AZURE_TENANT_ID: ${AZURE_TENANT_ID}/&quot; deploy/aad-pi-webhook.yaml
sed -i &quot;s/AZURE_ENVIRONMENT: .*/AZURE_ENVIRONMENT: ${AZURE_ENVIRONMENT}/&quot; deploy/aad-pi-webhook.yaml
kubectl apply -f deploy/aad-pi-webhook.yaml
</code></pre>
<details>
<summary>Output</summary>
<pre><code class="language-bash">namespace/aad-pi-webhook-system created
serviceaccount/aad-pi-webhook-admin created
role.rbac.authorization.k8s.io/aad-pi-webhook-manager-role created
clusterrole.rbac.authorization.k8s.io/aad-pi-webhook-manager-role created
rolebinding.rbac.authorization.k8s.io/aad-pi-webhook-manager-rolebinding created
clusterrolebinding.rbac.authorization.k8s.io/aad-pi-webhook-manager-rolebinding created
configmap/aad-pi-webhook-config created
secret/aad-pi-webhook-server-cert created
service/aad-pi-webhook-webhook-service created
deployment.apps/aad-pi-webhook-controller-manager created
mutatingwebhookconfiguration.admissionregistration.k8s.io/aad-pi-webhook-mutating-webhook-configuration created
</code></pre>
</details>
</li>
<li>
<p>Helm</p>
<pre><code class="language-bash">kubectl create namespace aad-pi-webhook-system
helm install pod-identity-webhook manifest_staging/charts/pod-identity-webhook \
   --namespace aad-pi-webhook-system \
   --set azureTenantID=&quot;${AZURE_TENANT_ID}&quot;
</code></pre>
<details>
<summary>Output</summary>
<pre><code class="language-bash">namespace/aad-pi-webhook-system created
NAME: pod-identity-webhook
LAST DEPLOYED: Wed Aug  4 10:49:20 2021
NAMESPACE: aad-pi-webhook-system
STATUS: deployed
REVISION: 1
TEST SUITE: None
</code></pre>
</details>
</li>
</ol>
<h2 id="4-create-an-azure-key-vault-and-secret"><a class="header" href="#4-create-an-azure-key-vault-and-secret">4. Create an Azure Key Vault and secret</a></h2>
<p>Export the following environment variables:</p>
<pre><code class="language-bash">export KEYVAULT_NAME=&quot;aad-pi-webhook-test-$(openssl rand -hex 2)&quot;
export KEYVAULT_SECRET_NAME=&quot;my-secret&quot;
</code></pre>
<p>Create an Azure Key Vault:</p>
<pre><code class="language-bash">az keyvault create --resource-group &quot;${RESOURCE_GROUP}&quot; \
   --location &quot;${LOCATION}&quot; \
   --name &quot;${KEYVAULT_NAME}&quot;
</code></pre>
<p>Create a secret:</p>
<pre><code class="language-bash">az keyvault secret set --vault-name &quot;${KEYVAULT_NAME}&quot; \
   --name &quot;${KEYVAULT_SECRET_NAME}&quot; \
   --value &quot;Hello!&quot;
</code></pre>
<h2 id="5-create-an-aad-application-and-grant-permissions-to-access-the-secret"><a class="header" href="#5-create-an-aad-application-and-grant-permissions-to-access-the-secret">5. Create an AAD application and grant permissions to access the secret</a></h2>
<pre><code class="language-bash">export APPLICATION_CLIENT_ID=&quot;$(az ad sp create-for-rbac --skip-assignment --name https://test-sp --query appId -otsv)&quot;
</code></pre>
<p>Set access policy for the AAD application to access the keyvault secret:</p>
<pre><code class="language-bash">az keyvault set-policy --name &quot;${KEYVAULT_NAME}&quot; \
  --secret-permissions get \
  --spn &quot;${APPLICATION_CLIENT_ID}&quot;
</code></pre>
</details>
<h2 id="6-create-a-kubernetes-service-account"><a class="header" href="#6-create-a-kubernetes-service-account">6. Create a Kubernetes service account</a></h2>
<p>Create a Kubernetes service account with the required labels and annotations.</p>
<pre><code class="language-bash">cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: v1
kind: ServiceAccount
metadata:
  annotations:
    azure.pod.identity/client-id: ${APPLICATION_CLIENT_ID}
  labels:
    azure.pod.identity/use: &quot;true&quot;
  name: pod-identity-sa
EOF
</code></pre>
<details>
<summary>Output</summary>
<pre><code class="language-bash">serviceaccount/pod-identity-sa created
</code></pre>
</details>
<p>If the AAD application is not in the same tenant as the Kubernetes cluster, then annotate the service account with the application tenant ID.</p>
<pre><code class="language-bash">kubectl annotate sa pod-identity-sa azure.pod.identity/tenant-id=&quot;${APPLICATION_TENANT_ID}&quot; --overwrite
</code></pre>
<h2 id="7-establish-trust-between-the-aad-application-and-the-service-account-issuer--subject"><a class="header" href="#7-establish-trust-between-the-aad-application-and-the-service-account-issuer--subject">7. Establish trust between the AAD application and the service account issuer &amp; subject</a></h2>
<p>Login to <a href="https://portal.azure.com/#cloudshell/">Azure Cloud Shell</a> and run the following commands:</p>
<pre><code class="language-bash"># Get the object ID of the AAD application
export APPLICATION_OBJECT_ID=&quot;$(az ad app show --id ${APPLICATION_CLIENT_ID} --query objectId -otsv)&quot;
# If you skip step 2
export SERVICE_ACCOUNT_ISSUER=&quot;...&quot;
</code></pre>
<p>Add the federated identity credential:</p>
<pre><code class="language-bash">cat &lt;&lt;EOF &gt; body.json
{
  &quot;name&quot;: &quot;kubernetes-federated-credential&quot;,
  &quot;issuer&quot;: &quot;${SERVICE_ACCOUNT_ISSUER}&quot;,
  &quot;subject&quot;: &quot;system:serviceaccount:default:pod-identity-sa&quot;,
  &quot;description&quot;: &quot;Kubernetes service account federated credential&quot;,
  &quot;audiences&quot;: [
    &quot;api://AzureADTokenExchange&quot;
  ]
}
EOF

az rest --method POST --uri &quot;https://graph.microsoft.com/beta/applications/${APPLICATION_OBJECT_ID}/federatedIdentityCredentials&quot; --body @body.json
</code></pre>
<h2 id="8-deploy-workload"><a class="header" href="#8-deploy-workload">8. Deploy workload</a></h2>
<p>Deploy a pod referencing the service account created in the last step:</p>
<pre><code class="language-bash">cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: quick-start
spec:
  serviceAccountName: pod-identity-sa
  containers:
    - image: aramase/dotnet:v0.4
      imagePullPolicy: IfNotPresent
      name: oidc
      env:
      - name: KEYVAULT_NAME
        value: ${KEYVAULT_NAME}
      - name: SECRET_NAME
        value: ${KEYVAULT_SECRET_NAME}
  nodeSelector:
    kubernetes.io/os: linux
EOF
</code></pre>
<details>
<summary>Output</summary>
<pre><code class="language-bash">pod/quick-start created
</code></pre>
</details>
<p>To check whether all properties are injected properly by the webhook:</p>
<pre><code class="language-bash">kubectl describe pod quick-start
</code></pre>
<details>
<summary>Output</summary>
<p>You can verify the following injected properties in the output:</p>
<table><thead><tr><th>Environment variable</th><th>Description</th></tr></thead><tbody>
<tr><td><code>AZURE_AUTHORITY_HOST</code></td><td>The Azure Active Directory (AAD) endpoint.</td></tr>
<tr><td><code>AZURE_CLIENT_ID</code></td><td>The client ID of the AAD application.</td></tr>
<tr><td><code>AZURE_TENANT_ID</code></td><td>The tenant ID of the registered AAD application.</td></tr>
<tr><td><code>TOKEN_FILE_PATH</code></td><td>The path of the projected service account token file.</td></tr>
</tbody></table>
<br/>
<table><thead><tr><th>Volume mount</th><th>Description</th></tr></thead><tbody>
<tr><td><code>/var/run/secrets/tokens/azure-identity-token</code></td><td>The path of the projected service account token file.</td></tr>
</tbody></table>
<br/>
<table><thead><tr><th>Volume</th><th>Description</th></tr></thead><tbody>
<tr><td><code>azure-identity-token</code></td><td>The projected service account volume.</td></tr>
</tbody></table>
<pre><code class="language-log">Name:         quick-start
Namespace:    default
Priority:     0
Node:         aad-pod-managed-identity-control-plane/172.18.0.2
Start Time:   Wed, 07 Jul 2021 14:45:38 -0700
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;
Status:       Running
IP:           10.244.0.9
IPs:
  IP:  10.244.0.9
Containers:
  oidc:
    Container ID:   containerd://efa8d09f78dc88dd17518ce5430ea820cef5743b33d77ae2b31e1082cc439218
    Image:          aramase/dotnet:v0.4
    Image ID:       docker.io/aramase/dotnet@sha256:821dbaa070bf7e26dd9172092658f6e6f910a2db198723e10b3ebb4e35a99eb5
    Port:           &lt;none&gt;
    Host Port:      &lt;none&gt;
    State:          Running
      Started:      Wed, 07 Jul 2021 14:45:45 -0700
    Ready:          True
    Restart Count:  0
    Environment:
      KEYVAULT_NAME:        ${KEYVAULT_NAME}
      SECRET_NAME:          ${KEYVAULT_SECRET_NAME}
      AZURE_AUTHORITY_HOST: (Injected by the webhook)
      AZURE_CLIENT_ID:      (Injected by the webhook)
      AZURE_TENANT_ID:      (Injected by the webhook)
      TOKEN_FILE_PATH:      (Injected by the webhook)
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from pod-identity-sa-token-mlgn8 (ro)
      /var/run/secrets/tokens from azure-identity-token (ro) (Injected by the webhook)
Conditions:
  Type              Status
  Initialized       True
  Ready             True
  ContainersReady   True
  PodScheduled      True
Volumes:
  pod-identity-sa-token-mlgn8:
    Type:        Secret (a volume populated by a Secret)
    SecretName:  pod-identity-sa-token-mlgn8
    Optional:    false
  azure-identity-token: (Injected by the webhook)
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  86400
QoS Class:                   BestEffort
Node-Selectors:              kubernetes.io/os=linux
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age    From               Message
  ----    ------     ----   ----               -------
  Normal  Scheduled  3m27s  default-scheduler  Successfully assigned default/quick-start to aad-pod-managed-identity-control-plane
  Normal  Pulling    3m26s  kubelet            Pulling image &quot;aramase/dotnet:v0.4&quot;
  Normal  Pulled     3m21s  kubelet            Successfully pulled image &quot;aramase/dotnet:v0.4&quot; in 5.824712366s
  Normal  Created    3m20s  kubelet            Created container oidc
  Normal  Started    3m20s  kubelet            Started container oidc
</code></pre>
</details>
<p>To verify that pod is able to get a token and access the secret from the Key Vault:</p>
<pre><code class="language-bash">kubectl logs quick-start
</code></pre>
<details>
<summary>Output</summary>
<p>If successful, the log output would be similar to the following output:</p>
<pre><code class="language-bash">START 07/07/2021 21:45:45 (quick-start)
Your secret is Hello!
</code></pre>
</details>
<h2 id="9-cleanup"><a class="header" href="#9-cleanup">9. Cleanup</a></h2>
<pre><code class="language-bash">kubectl delete pod quick-start
kubectl delete sa pod-identity-sa

az keyvault delete --name &quot;${KEYVAULT_NAME}&quot; --resource-group &quot;${RESOURCE_GROUP}&quot;
az ad sp delete --id &quot;${APPLICATION_CLIENT_ID}&quot;
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="introduction.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="concepts.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="introduction.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="concepts.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        
    </body>
</html>
